<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>My New Hugo Site</title>
  <meta name="description" content="相关代码vllm
_custom_ops.py distributed parallel_state.py device_communicators custom_all_reduce.py csrc custom_all_reduce.cuh custom_all_reduce.cu 关键细节可以直接跳转到：Reduce Scatter
符号解释 name 说明 world_size（ngpus） node中的GPU数量 rank_data 一个分配在GPU上的指针池，其中C&#43;&#43;中对RankData的定义是 struct{void * ptrs[8]}这里取8是因为CustomAllreduce操作支持的最大GPU数量是8，这几个指针分别指向同一node上的多个GPU上的即将用于allreduce操作的输入变量 “register” 下面函数的标识符中有register存在，register应该表示的是： 将内存中的RankData拷贝到GPU显存的rank_data池中 handle和ptr handle是通过CUDA进程间通信（IPC）函数获取的返回值，可以传递给其他进程并在其他进程通过OpenIpcHandle打开以获取ptr指针 API overview create_shared_buffer/free_shared_buffer ：	创建、释放共享内存（GPU上的内存） capture: @contextmanager	The main responsibility of this context manager is the register_graph_buffers call at the end of the context. register_graph_buffers should_custom_ar	：判断是否应该使用custom_all_reduce all_reduce :custom_all_reduce调用的函数，调用了cuda定义的函数 custom_all_reduce	对外调用的接口 is_weak_contiguous(Tensor): 判断Tensor是否“弱连续” Detailsis_weak_contiguous 判断一个Tensor是否为“弱连续”，弱连续的条件比torch.Tensor.is_contiguous宽松一些，代码如下。" /><link rel="canonical" href="http://localhost:1313/customallreduce/" itemprop="url" />

<meta property="og:title" content="" />
<meta property="og:description" content="相关代码vllm

_custom_ops.py
distributed

parallel_state.py
device_communicators

custom_all_reduce.py
csrc




custom_all_reduce.cuh
custom_all_reduce.cu

关键细节可以直接跳转到：Reduce Scatter
符号解释
  
      
          name
          说明
      
  
  
      
          world_size（ngpus）
          node中的GPU数量
      
      
          rank_data
          一个分配在GPU上的指针池，其中C&#43;&#43;中对RankData的定义是 struct{void * ptrs[8]}这里取8是因为CustomAllreduce操作支持的最大GPU数量是8，这几个指针分别指向同一node上的多个GPU上的即将用于allreduce操作的输入变量
      
      
          &ldquo;register&rdquo;
          下面函数的标识符中有register存在，register应该表示的是： 将内存中的RankData拷贝到GPU显存的rank_data池中
      
      
          handle和ptr
          handle是通过CUDA进程间通信（IPC）函数获取的返回值，可以传递给其他进程并在其他进程通过OpenIpcHandle打开以获取ptr指针
      
  

API overview
create_shared_buffer/free_shared_buffer ：	创建、释放共享内存（GPU上的内存）
capture: @contextmanager	The main responsibility of this context manager is the register_graph_buffers call at the end of the context.
register_graph_buffers
should_custom_ar	：判断是否应该使用custom_all_reduce
all_reduce :custom_all_reduce调用的函数，调用了cuda定义的函数
custom_all_reduce	对外调用的接口
is_weak_contiguous(Tensor): 判断Tensor是否“弱连续”

Detailsis_weak_contiguous
    判断一个Tensor是否为“弱连续”，弱连续的条件比torch.Tensor.is_contiguous宽松一些，代码如下。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/customallreduce/" /><meta property="article:section" content="" />



  <meta itemprop="name" content="My New Hugo Site">
  <meta itemprop="description" content="相关代码vllm
_custom_ops.py distributed parallel_state.py device_communicators custom_all_reduce.py csrc custom_all_reduce.cuh custom_all_reduce.cu 关键细节可以直接跳转到：Reduce Scatter
符号解释 name 说明 world_size（ngpus） node中的GPU数量 rank_data 一个分配在GPU上的指针池，其中C&#43;&#43;中对RankData的定义是 struct{void * ptrs[8]}这里取8是因为CustomAllreduce操作支持的最大GPU数量是8，这几个指针分别指向同一node上的多个GPU上的即将用于allreduce操作的输入变量 “register” 下面函数的标识符中有register存在，register应该表示的是： 将内存中的RankData拷贝到GPU显存的rank_data池中 handle和ptr handle是通过CUDA进程间通信（IPC）函数获取的返回值，可以传递给其他进程并在其他进程通过OpenIpcHandle打开以获取ptr指针 API overview create_shared_buffer/free_shared_buffer ：	创建、释放共享内存（GPU上的内存） capture: @contextmanager	The main responsibility of this context manager is the register_graph_buffers call at the end of the context. register_graph_buffers should_custom_ar	：判断是否应该使用custom_all_reduce all_reduce :custom_all_reduce调用的函数，调用了cuda定义的函数 custom_all_reduce	对外调用的接口 is_weak_contiguous(Tensor): 判断Tensor是否“弱连续” Detailsis_weak_contiguous 判断一个Tensor是否为“弱连续”，弱连续的条件比torch.Tensor.is_contiguous宽松一些，代码如下。">
  <meta itemprop="wordCount" content="399">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="My New Hugo Site">
  <meta name="twitter:description" content="相关代码vllm
_custom_ops.py distributed parallel_state.py device_communicators custom_all_reduce.py csrc custom_all_reduce.cuh custom_all_reduce.cu 关键细节可以直接跳转到：Reduce Scatter
符号解释 name 说明 world_size（ngpus） node中的GPU数量 rank_data 一个分配在GPU上的指针池，其中C&#43;&#43;中对RankData的定义是 struct{void * ptrs[8]}这里取8是因为CustomAllreduce操作支持的最大GPU数量是8，这几个指针分别指向同一node上的多个GPU上的即将用于allreduce操作的输入变量 “register” 下面函数的标识符中有register存在，register应该表示的是： 将内存中的RankData拷贝到GPU显存的rank_data池中 handle和ptr handle是通过CUDA进程间通信（IPC）函数获取的返回值，可以传递给其他进程并在其他进程通过OpenIpcHandle打开以获取ptr指针 API overview create_shared_buffer/free_shared_buffer ：	创建、释放共享内存（GPU上的内存） capture: @contextmanager	The main responsibility of this context manager is the register_graph_buffers call at the end of the context. register_graph_buffers should_custom_ar	：判断是否应该使用custom_all_reduce all_reduce :custom_all_reduce调用的函数，调用了cuda定义的函数 custom_all_reduce	对外调用的接口 is_weak_contiguous(Tensor): 判断Tensor是否“弱连续” Detailsis_weak_contiguous 判断一个Tensor是否为“弱连续”，弱连续的条件比torch.Tensor.is_contiguous宽松一些，代码如下。">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-block dark:hx-hidden" src="/images/logo.svg" alt="My New Hugo Site" height="20" width="20" />
        <img class="hx-hidden dark:hx-block" src="/images/logo.svg" alt="My New Hugo Site" height="20" width="20" />
        <span class="hx-mx-2 hx-font-extrabold hx-inline hx-select-none" title="My New Hugo Site">My New Hugo Site</span>
    </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex hx-max-w-screen-xl'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-hidden xl:hx-block">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/cuda%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/"
    
  >Cuda线程模型
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/customallreduce/"
    
  >Custom Allreduce
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#is_weak_contiguous"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >&lt;strong&gt;is_weak_contiguous&lt;/strong&gt;</a>
            </li>
          <li>
              <a
                href="#create_shared_buffer"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >&lt;strong&gt;create_shared_buffer&lt;/strong&gt;</a>
            </li>
          <li>
              <a
                href="#capture"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >&lt;strong&gt;capture&lt;/strong&gt;:</a>
            </li>
          <li>
              <a
                href="#register_graph_buffers"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >&lt;strong&gt;register_graph_buffers&lt;/strong&gt;</a>
            </li>
          <li>
              <a
                href="#all_reduce"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              >&lt;strong&gt;all_reduce&lt;/strong&gt;</a>
            </li>
          </ul>
  </li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/vllmnccl/"
    
  >Vllm&amp; Nccl
    </a></li>
    </ul>

    <div class="max-xl:hx-hidden hx-h-0 hx-w-64 hx-shrink-0"></div></div>
  
  
    <div class="md:hx-hidden  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul></ul><ul></ul><ul></ul><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#is_weak_contiguous">is_weak_contiguous
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#create_shared_buffer">create_shared_buffer
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#capture">capture:
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#register_graph_buffers">register_graph_buffers
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#all_reduce">all_reduce
        </a>
      </li></ul><ul></ul><ul></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400">
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        <br class="hx-mt-1.5 hx-text-sm" />
        
        <div class="hx-mb-16"></div>
        <div class="content">
          <h1>相关代码</h1><p>vllm</p>
<ul>
<li>_custom_ops.py</li>
<li>distributed
<ul>
<li>parallel_state.py</li>
<li>device_communicators
<ul>
<li>custom_all_reduce.py
csrc</li>
</ul>
</li>
</ul>
</li>
<li>custom_all_reduce.cuh</li>
<li>custom_all_reduce.cu</li>
</ul>
<p>关键细节可以直接跳转到：<a href="#ReduceScatter" >Reduce Scatter</a></p>
<h1>符号解释</h1><table>
  <thead>
      <tr>
          <th>name</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>world_size（ngpus）</td>
          <td>node中的GPU数量</td>
      </tr>
      <tr>
          <td>rank_data</td>
          <td>一个分配在GPU上的指针池，其中C++中对RankData的定义是 <code>struct{void * ptrs[8]}</code>这里取8是因为CustomAllreduce操作支持的最大GPU数量是8，这几个指针分别指向同一node上的多个GPU上的即将用于allreduce操作的输入变量</td>
      </tr>
      <tr>
          <td>&ldquo;register&rdquo;</td>
          <td>下面函数的标识符中有register存在，register应该表示的是： 将内存中的RankData拷贝到GPU显存的rank_data池中</td>
      </tr>
      <tr>
          <td>handle和ptr</td>
          <td>handle是通过CUDA进程间通信（IPC）函数获取的返回值，可以传递给其他进程并在其他进程通过OpenIpcHandle打开以获取ptr指针</td>
      </tr>
  </tbody>
</table>
<h1>API overview</h1><ul>
<li><a href="#create_shared_buffer" >create_shared_buffer</a>/free_shared_buffer ：	创建、释放共享内存（GPU上的内存）</li>
<li><a href="#capture" >capture</a>: @contextmanager	The main responsibility of this context manager is the <code>register_graph_buffers</code> call at the end of the context.</li>
<li><a href="#register_graph_buffers" >register_graph_buffers</a></li>
<li>should_custom_ar	：判断是否应该使用custom_all_reduce</li>
<li><a href="#all_reduce" >all_reduce</a> :custom_all_reduce调用的函数，调用了cuda定义的函数</li>
<li>custom_all_reduce	对外调用的接口</li>
<li><a href="#is_weak_contiguous" >is_weak_contiguous</a>(Tensor): 判断Tensor是否“弱连续”</li>
</ul>
<h1>Details</h1><h2><strong>is_weak_contiguous</strong><span class="hx-absolute -hx-mt-20" id="is_weak_contiguous"></span>
    <a href="#is_weak_contiguous" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>判断一个Tensor是否为“弱连续”，弱连续的条件比<code>torch.Tensor.is_contiguous</code>宽松一些，代码如下。</p>
<ul>
<li>definition</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<pre><code>def is_weak_contiguous(inp: torch.Tensor):

return inp.is_contiguous() or (inp.storage().nbytes() -

inp.storage_offset() * inp.element_size()

== inp.numel() * inp.element_size())</code></pre><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>如果输入张量在内存中分布“没有间隔”，而且处于整个已分配空间的最后一部分，那么<code>is_weak_contiguous</code>返回值为True，如下图所示：此时is_weak_contiguous返回值为False
![[Pasted image 20241218185931.png]]</li>
<li>如下图所示，此时<code>is_weak_contiguous</code>返回True
![[Pasted image 20241218190221.png]]
例如下面的程序输出为False，但是is_weak_contiguous输出为True，</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<pre><code>import torch

# example 1 矩阵转置操作会导致is_contiguous返回False，
# 但是is_weak_contiguous返回值仍然为True
x = torch.randn(2, 2)
y = x.transpose(0, 1)
print(y.is_contiguous()) # False
print(is_weak_contiguous(y)) # True

# example 2 处于整个Tensor的后半部分，且内存连续的tensor
a = torch.randn(8)
b = a[8:16].reshape(4, 2).transpose(0, 1)
c = a[0:8].reshape(4, 2).transpose(0, 1)
print(is_contiguous(b)) # True
print(is_contiguous(c)) # False</code></pre><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这个函数会在is_contiguous()返回值为False时继续判断，如果输入的Tensor在分配的内存中处于最后一段而且在内存中连续，则返回True</p>
<p>此函数的作用：
进行进程间通信时需要使用$getMemHandle$，获取到的Handle是指向预分配内存起始地址的Handle，需要有一个offset表示输入Tensor相对这个起始地址的偏移量</p>
<h2><strong>create_shared_buffer</strong><span class="hx-absolute -hx-mt-20" id="create_shared_buffer"></span>
    <a href="#create_shared_buffer" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><table>
  <thead>
      <tr>
          <th>返回字段</th>
          <th style="text-align: center">类型</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ptrs</td>
          <td style="text-align: center">List[int]</td>
          <td>一个指针数组，元素个数为world_size</td>
      </tr>
  </tbody>
</table>
<p>创建共享内存并返回指向共享内存的指针$ptrs$,其中调用了CUDA内存分配函数，并使用OpenIpcHandle打开了其他同一node上其他设备的共享内存handle。</p>
<h2><strong>capture</strong>:<span class="hx-absolute -hx-mt-20" id="capture"></span>
    <a href="#capture" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>这个函数是一个 <code>@contextmanager</code>，主要目的是在graph_capture最后调用 <code>register_graph_buffers</code>，将所有allreduce用到的输入地址注册到rank_data中。</p>
<p>解释：这个函数仅用于CUDA graph模式中，在CUDA graph 模式中，所有的操作不会立即被执行，CUDA会根据操作预先构建计算图，并一次性提交到GPU中执行，其中allreduce操作进行进程间通信需要将input注册到 <code>rank_data</code>中，这个注册的操作不会每次调用allreduce都执行一次，会在调用allreduce时将需要注册的ptr存入一个待注册数组（<code>graph_unreg_buffers_</code>）中，等到调用 <code>register_graph_buffers</code>时再将这些未被注册的ptr 进行 1. allgather获取其他进程中的handles。 2. 将这些获取到的handles打开并注册到 <code>rank_data</code>中</p>
<h2><strong>register_graph_buffers</strong><span class="hx-absolute -hx-mt-20" id="register_graph_buffers"></span>
    <a href="#register_graph_buffers" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>总是在capture上下文的最后调用，将capture上下文中执行的Allreduce代码中需要的input全部通过open_ipc_handle进行注册</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<pre><code>@contextmanager
def capture(self):
	try:
		self._IS_CAPTURING = True
		yield
	finally:
		self._IS_CAPTURING = False
		if not self.disabled:
			self.register_graph_buffers()</code></pre><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h2><strong>all_reduce</strong><span class="hx-absolute -hx-mt-20" id="all_reduce"></span>
    <a href="#all_reduce" class="subheading-anchor" aria-label="Permalink for this section"></a></h2><p>先进行一个条件的判断（是否处于CUDA graph 模式）如果不处于CUDA graph 模式，直接将input拷贝到预先分配的GPU buffer中，如果处于CUDA graph模式，直接input放入 <code>graph_unreg_buffers_</code>并进行allreduce操作。前面解释了这样做的原因</p>
<p>在C++函数内部有更细节的处理：</p>
<p>如果满足一些特定条件（full_nvlink_且输入Tensor比较大，在world_size&lt;=4时的阈值为512KB，world_size&lt;=8时的阈值为256KB），将调用 <code>cross_device_reduce_2stage</code>（CUDA核函数），否则调用 <code>cross_device_reduce_1stage</code></p>
<p><code>cross_device_reduce_2stage</code>详细解释：</p>
<ul>
<li>
<p><strong>stage 1: reduce scatter</strong>
首先，节点中的所有GPU只负责一部分的reduce，比如对于一个GPU的rank=rank，它负责处理 <code>input[start:end]</code> ，其中</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-apache" data-lang="apache"><span style="display:flex;"><span>part = size / ngpus; 
</span></span><span style="display:flex;"><span>start = rank * part ; 
</span></span><span style="display:flex;"><span>end = rank == world_size - <span style="color:#ae81ff">1</span> ? size : start + part; </span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>将这一部分reduce之后的结果放入一个预先分配的shared_memory中</p>
</li>
<li>
<p><strong>stage 2: allgather.</strong>
每个GPU读取shared_memory 中的数据，并将这些数据copy到result（最终的返回结果)中。</p>
</li>
</ul>
<p>重要代码简化版（部分同步代码省略）：</p>
<ul>
<li>第一阶段</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-apache" data-lang="apache"><span style="display:flex;"><span>for (int idx = start + tid; idx &lt; end; idx += stride) {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">将</span>reduce结果存入保存中间结果的共享内存
</span></span><span style="display:flex;"><span>    tmp_shared_buf[rank][idx] = packed_reduce(ptrs,idx);//
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>第2阶段：</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-apache" data-lang="apache"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">//</span> allgather操作
</span></span><span style="display:flex;"><span>for (int idx = tid; idx &lt; largest_part; idx += stride) {
</span></span><span style="display:flex;"><span>    for (int i = <span style="color:#ae81ff">0</span>; i &lt; ngpus; i++) {
</span></span><span style="display:flex;"><span>        int gather_from_rank = ((rank + i) % ngpus);
</span></span><span style="display:flex;"><span>        if (gather_from_rank == ngpus - <span style="color:#ae81ff">1</span> || idx &lt; part) {
</span></span><span style="display:flex;"><span>            int dst_idx = gather_from_rank * part + idx;
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">result[dst_idx]</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#960050;background-color:#1e0010">tmp_shared_buf[i][idx];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>关于第二阶段的同步操作，非常重要：
visibility across devices is only guaranteed between threads that have the same tid.</p>
<h1>ReduceScatter</h1><p><img src="https://cdn.nlark.com/yuque/0/2024/png/32583568/1734110259288-a5efb5c4-9ab3-486c-9797-80a81cfa3363.png?x-oss-process=image%2Fformat%2Cwebp" alt="" loading="lazy" />
四个设备的<code>reduce scatte</code>示意图</p>
<p>第一阶段： <code>reduce</code></p>
<ul>
<li>如上图所示，一个待reduce的Tensor，假设有4个设备rank1 2 3 4，在第一阶段时，每个GPU负责一个部分的reduce，如GPU1负责A区域的reduce，GPU2负责B区域以此类推。</li>
<li>reduce结束后，每个GPU上的都得到了最终reduce结果的一部分（保存在临时缓冲区），将它们allgather之后就完成了全部的reduce</li>
</ul>
<p>第二阶段： <code>allgather</code></p>
<ul>
<li>这里顺序有一定的讲究，比如rank2在allgaher操作时，读取的顺序依次是B C D A，因为rank2中已经有B的reduce结果了，rank3的顺序是 C D A B，</li>
</ul>
<p>两个阶段中的线程（GPU线程）同步操作：</p>
<ol>
<li>最简单的同步操作：
给所有线程设置一个<code>barrier</code>，等所有GPU上的所有线程都<code>reduce</code>结束后再进行第二阶段的<code>allgather</code>操作，但是显然这样的同步操作拖累了性能，造成了不必要的等待。</li>
<li>vllm的同步操作实现：
假设一个节点内有4个GPU，需要<code>allreduce</code>的<code>input</code>张量大小为403，即</li>
</ol>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<pre><code>world_size = 4
tensor.size() = 403</code></pre><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>那么，除了最后一个GPU，其余GPU负责的区域大小都是 403 / 4 = 100，最后一个GPU负责的区域大小是103</li>
<li>对一个进程内部，假设有10个线程，那么tid（GPU线程id）为1的就负责处理【1，11，21，&hellip;，91，101（如果有）】</li>
</ul>
<p>在一个进程中，tid=1 的线程，在<code>allgather</code>阶段，只需要其他进程中<code>tid</code>相同的线程<code>reduce</code>的结果，所以一个线程 tid=1 的线程只需要等待其他 $tid=1,rank\in [0,ngpus]$ 线程reduce结束后就可以进行<code>allgather</code>操作。
也就是说，GPU1中的线程1要等待所有GPU中的tid为1的线程<code>reduce</code>操作结束之后才能进行第二阶段的<code>allgather</code>操作。</p>
<p>但是在源码中，一个allreduce操作使用的GPU中的线程数量最高达到 $36 \times 512$  个，如果为这些线程全部设置同步操作，GPU之间的开销未免有些大（$36 \times 512$ 个线程全部都要与其他GPU的线程进行通信）。所以，源码中的实现采取的操作是：让一个block中的前<code>ngpus</code>个线程去与其他GPU通信。</p>
<p><strong>省流版：</strong>
简单来说，一个GPU中有多个线程 （36 * 512个），这些线程被分成多个block(36个)，每个block有多个thread（512个），其中线程同步只能发生在block内
所以上面的步骤可以说成是每个block派 <code>ngpus</code> 个线程与其他GPU进行同步操作，然后block内的线程再进行同步。</p>
<h1>QA</h1><p><strong>Question 1：</strong>
（这里我对源代码比较有疑问的一个点是：既然第二阶段<code>allgather</code>只有<code>read</code>操作，为什么还要将第一阶段的结果保存到临时缓冲区中而不是直接保存到最终的结果<code>result</code>中？ 直接保存到<code>result</code>中感觉不会影响第二阶段的<code>allgather</code>）</p>
<p><strong>已解决：</strong>
这里进行运算操作时，只有input张量和临时缓冲区是被注册到shared_buffer中的，其他进程访问不到<code>result</code>张量。如果每次进行<code>allreduce</code>都注册一个<code>result</code>变量作为共享内存，会增加进程间通信开销（在进程间传递shared_memory句柄）。</p>
<p><strong>Question 2：</strong>
CustomAllreduce的代码执行之前会有判断当前的张量并行数是否是<code>[2, 4, 6, 8]</code>，只有这几种数量的GPU且支持nvlink而且支持p2p通信才能进行CustomAllreduce，但是阅读了所有相关代码后发现代码逻辑中并没有出现与这些数相关的逻辑，只支持<code>[2, 4, 6, 8]</code>是否和nvlink拓扑结构有关？</p>
<p><strong>未解决</strong></p>

        </div>
        <div class="hx-mt-16"></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div class="hx-mx-auto hx-flex hx-gap-2 hx-py-2 hx-px-4 hx-max-w-screen-xl"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div><hr class="dark:hx-border-neutral-800" /><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>


<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/en.search.js" integrity=""></script>


  </body>
</html>
